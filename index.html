<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Animal Jam Color Code Generator</title>
  <style>
    :root{
      --panel-bg: rgba(255,255,255,.95);
      --radius: 12px;
      --shadow: 0 6px 20px rgba(0,0,0,.25);
      --blue: #2196f3;
      --blue-d: #1976d2;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background:url("background.png") no-repeat center center fixed;
      background-size:cover;
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .container{
      width:min(92vw,1300px);
      background:var(--panel-bg);
      border-radius:14px;
      padding:24px;
      display:flex;
      gap:32px;
      box-shadow:var(--shadow);
      flex-wrap:wrap;
    }
    .left-section{
      flex:1 1 280px;
      max-width:340px;
      display:flex;
      flex-direction:column;
      gap:16px;
      align-items:center;
    }
    #foxCanvas{
      width:100%;
      height:auto;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
      image-rendering: pixelated;
      background:#eee;
    }
    .form{
      width:100%;
      background:#fff;
      border-radius:12px;
      padding:16px;
      box-shadow:0 3px 8px rgba(0,0,0,.12);
    }
    .form-row{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:12px;
    }
    .form label{
      width:95px;
      text-align:right;
      font-size:14px;
      font-weight:600;
      color:#333;
    }
    .form input[type="number"]{
      flex:1;
      padding:8px;
      border:1px solid #ccc;
      border-radius:6px;
      font-size:14px;
      -moz-appearance:textfield;
    }
    .form input::-webkit-outer-spin-button,
    .form input::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
    .form button{
      width:100%; margin-top:12px;
      background:var(--blue); color:#fff; border:0;
      padding:12px; font-size:15px; font-weight:700;
      border-radius:6px; cursor:pointer; transition:.2s background;
    }
    .form button:hover{ background:var(--blue-d); }
    .result{
      margin-top:12px; padding:8px; min-height:30px;
      background:#fafafa; border:1px solid #ccc; border-radius:6px;
      font:13px/1.25 monospace; word-break:break-all; text-align:center;
    }
    .palette{
      flex:2 1 500px; display:flex; align-items:center; justify-content:center;
    }
    .palette img{
      max-width:100%; height:auto; border-radius:10px;
      box-shadow:0 3px 8px rgba(0,0,0,.1);
    }
    @media (max-width: 900px){
      .container{flex-direction:column; align-items:center}
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Live fox preview -->
    <div class="left-section">
      <canvas id="foxCanvas"></canvas>

      <!-- Controls -->
      <div class="form">
        <div class="form-row"><label>Primary:</label>   <input type="number" id="primary"   min="0" max="255" value="0"></div>
        <div class="form-row"><label>Secondary:</label> <input type="number" id="secondary" min="0" max="255" value="0"></div>
        <div class="form-row"><label>Pattern 1:</label> <input type="number" id="p1"       min="0" max="255" value="0"></div>
        <div class="form-row"><label>Pattern 2:</label> <input type="number" id="p2"       min="0" max="255" value="0"></div>
        <div class="form-row"><label>Pattern 3:</label> <input type="number" id="p3"       min="0" max="255" value="0"></div>
        <div class="form-row"><label>Pattern 4:</label> <input type="number" id="p4"       min="0" max="255" value="0"></div>
        <div class="form-row"><label>Eyes:</label>      <input type="number" id="eyes"     min="0" max="255" value="0"></div>
        <div class="form-row"><label>Room:</label>      <input type="number" id="room"     min="0" max="999999" value="0"></div>

        <div class="result" id="result"></div>
      </div>
    </div>

    <!-- Palette image (for reference) -->
    <div class="palette">
      <img id="paletteImg" src="colors.png" alt="Color Palette">
    </div>
  </div>

  <canvas id="paletteSampler" style="display:none"></canvas>

  <script>
    const clamp = (n, lo, hi) => Math.max(lo, Math.min(hi, n|0));
    const num = id => clamp(id, 0, 255);

    function loadImage(src){
      return new Promise((res, rej) => {
        const img = new Image();
        img.onload = () => res(img);
        img.onerror = () => rej(new Error('Failed to load ' + src));
        img.src = src;
      });
    }

    function paletteSamplerFactory(paletteImg){
      const sampler = document.getElementById('paletteSampler');
      const ctx = sampler.getContext('2d', { willReadFrequently: true });

      sampler.width  = paletteImg.naturalWidth;
      sampler.height = paletteImg.naturalHeight;
      ctx.imageSmoothingEnabled = false;
      ctx.drawImage(paletteImg, 0, 0);

      const COLS = 20, ROWS = 13;
      const cw = sampler.width  / COLS;
      const ch = sampler.height / ROWS;

      const LAST_ROW_START_COL = 2;
      const LAST_ROW_END_COL   = 17;

      function sampleCell(col, row){
        const cx = (col + 0.5) * cw;
        const cy = (row + 0.70) * ch;
        const x0 = Math.max(0, Math.min(sampler.width  - 3, Math.round(cx) - 2));
        const y0 = Math.max(0, Math.min(sampler.height - 3, Math.round(cy) - 2));
        const data = ctx.getImageData(x0, y0, 5, 5).data;

        let r=0,g=0,b=0,n=0;
        for(let i=0;i<data.length;i+=4){
          const R=data[i], G=data[i+1], B=data[i+2], A=data[i+3];
          const max=Math.max(R,G,B), min=Math.min(R,G,B);
          if(A>8 && !(max<12 || min>244)){ r+=R; g+=G; b+=B; n++; }
        }
        if(!n){
          const d=ctx.getImageData(Math.round(cx),Math.round(cy),1,1).data;
          r=d[0]; g=d[1]; b=d[2]; n=1;
        }
        r=Math.round(r/n); g=Math.round(g/n); b=Math.round(b/n);
        return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
      }

      return function pick(id){
        id = num(id);
        if(id < 240){
          const row = (id / 20) | 0;
          const col = id % 20;
          return sampleCell(col, row);
        } else {
          const row = 12;
          let col = LAST_ROW_START_COL + (id - 240);
          col = Math.max(LAST_ROW_START_COL, Math.min(LAST_ROW_END_COL, col));
          return sampleCell(col, row);
        }
      };
    }

    function drawTinted(targetCtx, maskImg, color, blend='source-over'){
      const w = targetCtx.canvas.width, h = targetCtx.canvas.height;
      const off = document.createElement('canvas');
      off.width = w; off.height = h;
      const octx = off.getContext('2d');
      octx.imageSmoothingEnabled = false;

      octx.globalCompositeOperation = 'source-over';
      octx.fillStyle = color;
      octx.fillRect(0,0,w,h);

      octx.globalCompositeOperation = 'destination-in';
      octx.drawImage(maskImg, 0, 0, w, h);

      targetCtx.save();
      targetCtx.globalCompositeOperation = blend;
      targetCtx.drawImage(off, 0, 0);
      targetCtx.restore();
    }

    (async function init(){
      const canvas   = document.getElementById('foxCanvas');
      const ctx      = canvas.getContext('2d');
      ctx.imageSmoothingEnabled = false;

      const inputs = ['primary','secondary','p1','p2','p3','p4','eyes','room']
        .map(id => document.getElementById(id));
      const [inPrimary,inSecondary,inP1,inP2,inP3,inP4,inEyes,inRoom] = inputs;

      const resultEl = document.getElementById('result');

      const [
        baseImg, staticImg, eyesMask,
        primaryMask, secondaryMask,
        p1Mask, p2Mask, p3Mask, p4Mask,
        paletteImg
      ] = await Promise.all([
        loadImage('base.png'),
        loadImage('static.png'),
        loadImage('eyes.png'),
        loadImage('primary.png'),
        loadImage('secondary.png'),
        loadImage('pattern-1.png'),
        loadImage('pattern-2.png'),
        loadImage('pattern-3.png'),
        loadImage('pattern-4.png'),
        loadImage('colors.png'),
      ]);

      canvas.width  = baseImg.naturalWidth;
      canvas.height = baseImg.naturalHeight;

      const colorFromId = paletteSamplerFactory(paletteImg);

      function drawFox(){
        const P  = num(inPrimary.value);
        const S  = num(inSecondary.value);
        const c1 = num(inP1.value), c2 = num(inP2.value),
              c3 = num(inP3.value), c4 = num(inP4.value);
        const Ey = num(inEyes.value);

        const colP  = colorFromId(P);
        const colS  = colorFromId(S);
        const col1  = colorFromId(c1);
        const col2  = colorFromId(c2);
        const col3  = colorFromId(c3);
        const col4  = colorFromId(c4);
        const colEy = colorFromId(Ey);

        ctx.clearRect(0,0,canvas.width,canvas.height);

        drawTinted(ctx, primaryMask,   colP,  'source-over');
        drawTinted(ctx, secondaryMask, colS,  'source-over');
        drawTinted(ctx, p1Mask,        col1,  'source-over');
        drawTinted(ctx, p2Mask,        col2,  'source-over');
        drawTinted(ctx, p3Mask,        col3,  'source-over');
        drawTinted(ctx, p4Mask,        col4,  'source-over');
        drawTinted(ctx, eyesMask,      colEy, 'source-over');

        ctx.globalCompositeOperation = 'multiply';
        ctx.drawImage(baseImg, 0, 0, canvas.width, canvas.height);

        ctx.globalCompositeOperation = 'source-over';
        ctx.drawImage(staticImg, 0, 0, canvas.width, canvas.height);
      }

      function generateNumbers(){
        const primary   = num(inPrimary.value);
        const secondary = num(inSecondary.value);
        let number1 = (primary << 24) | (secondary << 16);
        number1 >>>= 0;

        const p1 = num(inP1.value), p2 = num(inP2.value), p3 = num(inP3.value), p4 = num(inP4.value);
        let number2 = (p1 << 24) | (p2 << 16) | (p3 << 8) | p4;
        number2 >>>= 0;

        const eyes = num(inEyes.value);
        let number3 = (eyes << 24);
        number3 >>>= 0;

        const room = parseInt(inRoom.value) || 0;

        resultEl.textContent = `%xt%o%ap%${room}%${number1}%${number2}%${number3}%1033%`;
      }

      for(const el of inputs){
        el.addEventListener('input', () => { drawFox(); generateNumbers(); });
      }

      drawFox();
      generateNumbers();
    })();
  </script>
</body>
</html>
